name: è¯ä¸¸è®ºå›è‡ªåŠ¨ç­¾åˆ°

on:
  schedule:
    - cron: '30 16 * * *'  # åŒ—äº¬æ—¶é—´æ¯å¤©00:30æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # å¯ç”¨pipç¼“å­˜ï¼ˆä¾èµ–requirements.txtï¼‰

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # ä»ä¾èµ–æ–‡ä»¶å®‰è£…
          sudo apt-get update && sudo apt-get install -y jq

      - name: æ‰“å°æ‰§è¡Œæ—¶é—´
        run: |
          echo "æ‰§è¡Œæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date -d '+8 hour' '+%Y-%m-%d %H:%M:%S')"

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
          INVITES_USERNAME: ${{ secrets.INVITES_USERNAME }}
          INVITES_PASSWORD: ${{ secrets.INVITES_PASSWORD }}
        run: |
          python checkin.py  # ç¡®ä¿è„šæœ¬è·¯å¾„æ­£ç¡®

      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰
        if: always()  # æ— è®ºæˆè´¥éƒ½å‘é€é€šçŸ¥
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          RESULT: ${{ steps.checkin_step.outputs.checkin_result }}
          MSG: ${{ steps.checkin_step.outputs.checkin_msg }}
        run: |
          # 1. æ„é€ æ ‡é¢˜ï¼ˆé€»è¾‘ä¸å˜ï¼‰
          if [ "$RESULT" = "success" ]; then
              TITLE="âœ… è¯ä¸¸è®ºå›ç­¾åˆ°æˆåŠŸ"
          else
              TITLE="âŒ è¯ä¸¸è®ºå›ç­¾åˆ°å¤±è´¥"
          fi

          # 2. æ„é€ å†…å®¹ï¼ˆä¿®å¤ï¼šæ­£ç¡®è¿˜åŸæ¢è¡Œç¬¦ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ï¼‰
          CONTENT="### $TITLE\n$(echo "$MSG" | sed 's/\\n/\n/g')\n\nğŸ“¢ GitHub Actions è‡ªåŠ¨æ¨é€"
          
          # 3. ä¿®å¤æ ¸å¿ƒï¼šç”¨jqæ­£ç¡®æ„é€ JSONï¼ˆé¿å…URLè§£æé”™è¯¯ï¼‰
          JSON_DATA=$(jq -n \
              --arg msgtype "markdown" \
              --arg content "$CONTENT" \
              '{"msgtype": $msgtype, "markdown": {"content": $content}}')
          
          # 4. å‘é€è¯·æ±‚ï¼ˆå¢åŠ URLæ ¡éªŒå’Œè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥ï¼‰
          echo "=== å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ ==="
          echo "WebHook URLå‰ç¼€ï¼š${WECHAT_WEBHOOK:0:30}..."  # éšè—æ•æ„Ÿä¿¡æ¯
          echo "é€šçŸ¥å†…å®¹ï¼š$CONTENT"
          
          # æ‰§è¡Œcurlï¼ˆä¿®å¤ï¼šæ ‡å‡†æ ¼å¼ï¼Œå¢åŠ é‡è¯•å’Œè¶…æ—¶ï¼‰
          curl -X POST "$WECHAT_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA" \
              --max-time 15 \
              --retry 3 \
              -v  # è¯¦ç»†æ—¥å¿—ï¼Œå®šä½é—®é¢˜
