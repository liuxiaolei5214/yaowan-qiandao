name: è¯ä¸¸è®ºå›è‡ªåŠ¨ç­¾åˆ°

# è§¦å‘è§„åˆ™ï¼šæ¯å¤©å‡Œæ™¨0ç‚¹30åˆ†ï¼ˆUTC+8ï¼‰+ æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '30 16 * * *'  # UTC 16:30 = åŒ—äº¬æ—¶é—´ 00:30
  workflow_dispatch:

# ä½œä¸šé…ç½®
jobs:
  checkin_job:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è¶…æ—¶æ—¶é—´ï¼ˆé¿å…å¡æ­»ï¼‰
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: é…ç½®Python 3.10ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ é€Ÿè¿è¡Œ

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–å’Œjqå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install requests
          sudo apt-get update && sudo apt-get install -y jq

      # æ­¥éª¤4ï¼šè®°å½•è§¦å‘æ—¶é—´
      - name: æ‰“å°è§¦å‘æ—¶é—´
        run: |
          echo "è„šæœ¬è§¦å‘æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date -d '+8 hour' '+%Y-%m-%d %H:%M:%S')"

      # æ­¥éª¤5ï¼šæ‰§è¡Œç­¾åˆ°è„šæœ¬
      - name: è¿è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
          INVITES_USERNAME: ${{ secrets.INVITES_USERNAME }}
          INVITES_PASSWORD: ${{ secrets.INVITES_PASSWORD }}
        run: |
          python checkin.py

      # æ­¥éª¤6ï¼šå‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
      - name: æ¨é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: always()  # æ— è®ºç­¾åˆ°æˆåŠŸ/å¤±è´¥ï¼Œéƒ½å‘é€é€šçŸ¥
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          CHECKIN_RESULT: ${{ steps.checkin_step.outputs.checkin_result }}
          CHECKIN_MSG: ${{ steps.checkin_step.outputs.checkin_msg }}
        run: |
          # æ„é€ é€šçŸ¥æ ‡é¢˜
          if [ "$CHECKIN_RESULT" = "success" ]; then
              TITLE="âœ… è¯ä¸¸è®ºå›ç­¾åˆ°æˆåŠŸ"
          else
              TITLE="âŒ è¯ä¸¸è®ºå›ç­¾åˆ°å¤±è´¥"
          fi
          
          # è¿˜åŸæ¢è¡Œç¬¦å¹¶æ„é€ å†…å®¹
          CONTENT="### $TITLE\n$(echo "$CHECKIN_MSG" | sed 's/\\n/\n/g')\n\nğŸ“¢ GitHub Actions è‡ªåŠ¨æ¨é€"
          
          # æ„é€ JSONå¹¶å‘é€è¯·æ±‚
          JSON_DATA=$(jq -n \
              --arg msgtype "markdown" \
              --arg content "$CONTENT" \
              '{"msgtype": $msgtype, "markdown": {"content": $content}}')
          
          # å‘é€é€šçŸ¥ï¼ˆæ·»åŠ è¶…æ—¶å’Œé‡è¯•ï¼‰
          curl -X POST "$WECHAT_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA" \
              --max-time 10 \
              --retry 2
