name: è¯ä¸¸è®ºå›æ¯æ—¥ç­¾åˆ°

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 æ‰§è¡Œ (UTC+8)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  checkin:
    runs-on: ubuntu-latest
    name: è¯ä¸¸è®ºå›ç­¾åˆ°
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      # === å…³é”®ï¼šå°† secrets å®‰å…¨åŠ è½½åˆ°ç¯å¢ƒå˜é‡ ===
      - name: Load secrets into environment
        run: |
          # åªæœ‰å½“ secret éç©ºæ—¶æ‰å†™å…¥ envï¼Œé¿å…å†™å…¥ "null" å­—ç¬¦ä¸²
          [ -n " $ {{ secrets.USERNAME }}" ] && echo "USERNAME= $ {{ secrets.USERNAME }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.PASSWORD }}" ] && echo "PASSWORD= $ {{ secrets.PASSWORD }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.DINGTALK_WEBHOOK }}" ] && echo "DINGTALK_WEBHOOK= $ {{ secrets.DINGTALK_WEBHOOK }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.WECHAT_WEBHOOK }}" ] && echo "WECHAT_WEBHOOK= $ {{ secrets.WECHAT_WEBHOOK }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.SERVERCHAN_SENDKEY }}" ] && echo "SERVERCHAN_SENDKEY= $ {{ secrets.SERVERCHAN_SENDKEY }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.EMAIL_USERNAME }}" ] && echo "EMAIL_USERNAME= $ {{ secrets.EMAIL_USERNAME }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.EMAIL_PASSWORD }}" ] && echo "EMAIL_PASSWORD= $ {{ secrets.EMAIL_PASSWORD }}" >>  $ GITHUB_ENV
          [ -n " $ {{ secrets.NOTIFY_EMAIL }}" ] && echo "NOTIFY_EMAIL= $ {{ secrets.NOTIFY_EMAIL }}" >>  $ GITHUB_ENV

      - name: Run checkin script
        id: checkin_step
        env:
          USERNAME:  $ {{ env.USERNAME }}
          PASSWORD:  $ {{ env.PASSWORD }}
        run: |
          python scripts/checkin.py
          # ç¡®ä¿è„šæœ¬é€šè¿‡  $ GITHUB_OUTPUT è®¾ç½®è¾“å‡º
          # ç¤ºä¾‹ï¼š
          # echo "checkin_result=success" >>  $ GITHUB_OUTPUT
          # echo "message=ç­¾åˆ°æˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ã€‚" >>  $ GITHUB_OUTPUT

      # =============== é€šçŸ¥éƒ¨åˆ† ===============
      
      # é’‰é’‰é€šçŸ¥
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if:  ${{ env.DINGTALK_WEBHOOK != '' }}
        uses: zcorg1993/dingtalk-action@v2
        with:
          url:  $ {{ env.DINGTALK_WEBHOOK }}
          msg: |
            ğŸ‰ è¯ä¸¸è®ºå›ç­¾åˆ°
            ğŸ‘‰  $ {{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… æˆåŠŸ!' || 'âŒ å¤±è´¥!' }}
            ğŸ’¬  $ {{ steps.checkin_step.outputs.message }}

      # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if:  ${{ env.WECHAT_WEBHOOK != '' }}
        uses: Guo-Linka/WeCom-Workflow-Action@main
        with:
          wecom_webhook:  $ {{ env.WECHAT_WEBHOOK }}
          wecom_msg: |
            {"msgtype":"text","text":{"content":"ğŸ‰ è¯ä¸¸è®ºå›ç­¾åˆ°\nğŸ‘‰  $ {{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… æˆåŠŸ!' || 'âŒ å¤±è´¥!' }}\nğŸ’¬  $ {{ steps.checkin_step.outputs.message }}"}}

      # Serveré…±é€šçŸ¥
      - name: å‘é€Serveré…±é€šçŸ¥
        if:  ${{ env.SERVERCHAN_SENDKEY != '' }}
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://sctapi.ftqq.com/ $ {{ env.SERVERCHAN_SENDKEY }}.send'
          method: 'POST'
          data: '{"title":"è¯ä¸¸è®ºå›ç­¾åˆ°","desp":"çŠ¶æ€ï¼š $ {{ steps.checkin_step.outputs.checkin_result == ''success'' ? ''âœ… æˆåŠŸ'' : ''âŒ å¤±è´¥'' }}\\n\\nç»“æœï¼š $ {{ steps.checkin_step.outputs.message }}"}'
          headers: '{"Content-Type":"application/json"}'

      # é‚®ä»¶é€šçŸ¥
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if:  ${{ env.EMAIL_USERNAME != '' && env.EMAIL_PASSWORD != '' && env.NOTIFY_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username:  $ {{ env.EMAIL_USERNAME }}
          password:  $ {{ env.EMAIL_PASSWORD }}
          to:  $ {{ env.NOTIFY_EMAIL }}
          from:  $ {{ env.EMAIL_USERNAME }}
          subject: è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
          body: |
            çŠ¶æ€:  $ {{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            è¯¦æƒ…:  $ {{ steps.checkin_step.outputs.message }}
