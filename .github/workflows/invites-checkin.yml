name: 药丸论坛签到

on:
  # 定时触发（每天9点执行，UTC时间1点 = 北京时间9点）
  schedule:
    - cron: '0 1 * * *'
  # 手动触发
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    outputs:
      checkin_result: ${{ steps.checkin_step.outputs.checkin_result }}
      checkin_msg: ${{ steps.checkin_step.outputs.checkin_msg }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: 记录触发时间（验证定时任务）
        run: |
          echo "定时任务触发成功，当前时间（UTC）：$(date -u)"
          echo "当前时间（北京时间）：$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')"
          
      - name: 执行签到脚本
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
        run: python checkin.py
      
      - name: 发送签到结果邮件
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 药丸论坛签到通知 - ${{ steps.checkin_step.outputs.checkin_result }}
          body: |
            药丸论坛签到任务执行结果：
            ${{ steps.checkin_step.outputs.checkin_msg }}
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions
          secure: true
