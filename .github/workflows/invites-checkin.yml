name: è¯ä¸¸è®ºå›ç­¾åˆ°

on:
  # å®šæ—¶è§¦å‘ï¼ˆUTC 1ç‚¹30åˆ† = åŒ—äº¬æ—¶é—´9ç‚¹30åˆ†ï¼Œéæ•´ç‚¹é¿å…é«˜å³°ï¼‰
  schedule:
    - cron: '30 1 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    outputs:
      checkin_result: ${{ steps.checkin_step.outputs.checkin_result }}
      checkin_msg: ${{ steps.checkin_step.outputs.checkin_msg }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: è®°å½•è§¦å‘æ—¶é—´ï¼ˆéªŒè¯å®šæ—¶ä»»åŠ¡ï¼‰
        run: |
          echo "å®šæ—¶ä»»åŠ¡è§¦å‘æˆåŠŸï¼Œå½“å‰æ—¶é—´ï¼ˆUTCï¼‰ï¼š$(date -u)"
          echo "å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')"
      
      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
        run: python checkin.py
      
      # ---------------------- 1. é’‰é’‰é€šçŸ¥ï¼ˆé…ç½® DINGTALK_WEBHOOK åˆ™å¯ç”¨ï¼‰ ----------------------
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: ${{ secrets.DINGTALK_WEBHOOK != '' && secrets.DINGTALK_WEBHOOK != null }}
        uses: zcong1993/dingtalk-action@v2
        with:
          url: ${{ secrets.DINGTALK_WEBHOOK }}
          msg: |
            # è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
            ## ${{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            ---
            ${{ steps.checkin_step.outputs.checkin_msg }}
            ---
            ğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€
          type: markdown
        continue-on-error: true
      
      # ---------------------- 2. ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆé…ç½® WECOM_WEBHOOK åˆ™å¯ç”¨ï¼‰ ----------------------
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: ${{ secrets.WECOM_WEBHOOK != '' && secrets.WECOM_WEBHOOK != null }}
        uses: chf007/action-wechat-work@master
        with:
          msgtype: markdown
          webhook: ${{ secrets.WECOM_WEBHOOK }}
          content: |
            ### è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
            > **çŠ¶æ€**ï¼š${{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            > **è¯¦æƒ…**ï¼š
            > ${{ steps.checkin_step.outputs.checkin_msg }}
            > **æ‰§è¡Œæ—¶é—´**ï¼š${{ github.run_at }}
            > **ğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€**
        continue-on-error: true
      
      # ---------------------- 3. Server é…±é€šçŸ¥ï¼ˆé…ç½® SERVERCHAN_SENDKEY åˆ™å¯ç”¨ï¼‰ ----------------------
      - name: å‘é€ Server é…±é€šçŸ¥
        if: ${{ secrets.SERVERCHAN_SENDKEY != '' && secrets.SERVERCHAN_SENDKEY != null }}
        run: |
          curl -X POST "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_SENDKEY }}.send" \
          -d "title=è¯ä¸¸è®ºå›ç­¾åˆ°-${{ steps.checkin_step.outputs.checkin_result }}" \
          -d "desp=### è¯ä¸¸è®ºå›ç­¾åˆ°è¯¦æƒ…\n\n${{ steps.checkin_step.outputs.checkin_msg }}\n\n---\nğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€"
        continue-on-error: true
      
      # ---------------------- 4. é‚®ä»¶é€šçŸ¥ï¼ˆé…ç½® EMAIL_USERNAMEã€EMAIL_PASSWORDã€NOTIFY_EMAIL å‡é…ç½®åˆ™å¯ç”¨ï¼‰ ----------------------
      - name: å‘é€ç­¾åˆ°ç»“æœé‚®ä»¶
        if: ${{ secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != '' && secrets.NOTIFY_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥ - ${{ steps.checkin_step.outputs.checkin_result }}
          body: |
            ã€è¯ä¸¸è®ºå›ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œç»“æœã€‘
            â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            ${{ steps.checkin_step.outputs.checkin_msg }}
            â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions
          secure: true
        continue-on-error: true
