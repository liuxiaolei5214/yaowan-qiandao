name: è¯ä¸¸è®ºå›ç­¾åˆ°

on:
  schedule:
    - cron: '20 1 * * *'  # UTC 1:20 = åŒ—äº¬æ—¶é—´ 9:20ï¼ˆæ³¨é‡Šä¿®æ­£ï¼ŒåŸæ³¨é‡Šå†™çš„"UTC 2ç‚¹"æ˜¯é”™è¯¯çš„ï¼‰
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests cryptography

      - name: è®°å½•è§¦å‘æ—¶é—´
        run: |
          echo "å®šæ—¶ä»»åŠ¡è§¦å‘æˆåŠŸï¼Œå½“å‰æ—¶é—´ï¼ˆUTCï¼‰ï¼š$(date -u)"
          echo "å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')"

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
          INVITES_USERNAME: ${{ secrets.INVITES_USERNAME }}
          INVITES_PASSWORD: ${{ secrets.INVITES_PASSWORD }}
        run: python checkin.py

      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        run: |
          # è·å–åŒ—äº¬æ—¶é—´ï¼ˆè§£å†³æ‰§è¡Œæ—¶é—´æœªçŸ¥ï¼‰
          BEIJING_TIME=$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')
          # æ„é€ é€šçŸ¥å†…å®¹ï¼ˆå¾®è°ƒæ ¼å¼ï¼Œä¸Cloudflareä¸€è‡´ï¼‰
          CONTENT=$(cat << EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "content": "### è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥\n> ${ { steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸï¼' || 'âŒ ç­¾åˆ°å¤±è´¥ï¼' } }\n> ${{ steps.checkin_step.outputs.checkin_msg || 'æš‚æ— è¯¦ç»†ä¿¡æ¯' }}\n> ğŸ¤– GitHub Actions è‡ªåŠ¨æ¨é€"
            }
          }
          EOF
          )
          # è°ƒç”¨ä¼ä¸šå¾®ä¿¡API
          curl -X POST "${{ secrets.WECOM_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$CONTENT"
        continue-on-error: true
