name: è¯ä¸¸è®ºå›ç­¾åˆ°

on:
  schedule:
    - cron: '0 1 * * *'  # UTC 1ç‚¹30åˆ† = åŒ—äº¬æ—¶é—´9ç‚¹30åˆ†
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # å¿…é¡»æˆäºˆè¯¥æƒé™ï¼Œæ‰èƒ½æ›´æ–° Secret
    outputs:
      checkin_result: ${{ steps.checkin_step.outputs.checkin_result }}
      checkin_msg: ${{ steps.checkin_step.outputs.checkin_msg }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: å®‰è£…ä¾èµ–ï¼ˆå«åŠ å¯†åº“ï¼‰
        run: |
          python -m pip install --upgrade pip
          pip install requests cryptography  # æ–°å¢ cryptography ç”¨äºåŠ å¯† Secret
      
      - name: è®°å½•è§¦å‘æ—¶é—´
        run: |
          echo "å®šæ—¶ä»»åŠ¡è§¦å‘æˆåŠŸï¼Œå½“å‰æ—¶é—´ï¼ˆUTCï¼‰ï¼š$(date -u)"
          echo "å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')"
      
      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
          INVITES_USERNAME: ${{ secrets.INVITES_USERNAME }}  # æ–°å¢ï¼šç”¨æˆ·å Secret
          INVITES_PASSWORD: ${{ secrets.INVITES_PASSWORD }}  # æ–°å¢ï¼šå¯†ç  Secret
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # å†…ç½® Tokenï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
          GITHUB_REPOSITORY: ${{ github.repository }}  # å†…ç½®ä»“åº“ä¿¡æ¯ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
        run: python checkin.py
      
      # ä»¥ä¸‹é€šçŸ¥æ­¥éª¤ä¿æŒä¸å˜ï¼ˆé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€Server é…±ã€é‚®ä»¶ï¼‰
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: ${{ secrets.DINGTALK_WEBHOOK != '' && secrets.DINGTALK_WEBHOOK != null }}
        uses: zcong1993/dingtalk-action@v2
        with:
          url: ${{ secrets.DINGTALK_WEBHOOK }}
          msg: |
            # è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
            ## ${{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            ---
            ${{ steps.checkin_step.outputs.checkin_msg }}
            ---
            ğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€
          type: markdown
        continue-on-error: true
      
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: ${{ secrets.WECOM_WEBHOOK != '' && secrets.WECOM_WEBHOOK != null }}
        uses: chf007/action-wechat-work@master
        with:
          msgtype: markdown
          webhook: ${{ secrets.WECOM_WEBHOOK }}
          content: |
            ### è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
            > **çŠ¶æ€**ï¼š${{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            > **è¯¦æƒ…**ï¼š
            > ${{ steps.checkin_step.outputs.checkin_msg }}
            > **æ‰§è¡Œæ—¶é—´**ï¼š${{ github.run_at }}
            > **ğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€**
        continue-on-error: true
      
      - name: å‘é€ Server é…±é€šçŸ¥
        if: ${{ secrets.SERVERCHAN_SENDKEY != '' && secrets.SERVERCHAN_SENDKEY != null }}
        run: |
          curl -X POST "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_SENDKEY }}.send" \
          -d "title=è¯ä¸¸è®ºå›ç­¾åˆ°-${{ steps.checkin_step.outputs.checkin_result }}" \
          -d "desp=### è¯ä¸¸è®ºå›ç­¾åˆ°è¯¦æƒ…\n\n${{ steps.checkin_step.outputs.checkin_msg }}\n\n---\nğŸ¤– æ¥è‡ª GitHub Actions è‡ªåŠ¨æ¨é€"
        continue-on-error: true
      
      - name: å‘é€ç­¾åˆ°ç»“æœé‚®ä»¶
        if: ${{ secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != '' && secrets.NOTIFY_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥ - ${{ steps.checkin_step.outputs.checkin_result }}
          body: |
            ã€è¯ä¸¸è®ºå›ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œç»“æœã€‘
            â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            ${{ steps.checkin_step.outputs.checkin_msg }}
            â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions
          secure: true
        continue-on-error: true
