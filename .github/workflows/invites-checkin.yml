name: è¯ä¸¸è®ºå›ç­¾åˆ°

on:
  schedule:
    - cron: '30 2 * * *'  # UTC 2ç‚¹ = åŒ—äº¬æ—¶é—´10ç‚¹ï¼ˆå¦‚éœ€9ç‚¹æ”¹ä¸º 30 1 * * *ï¼‰
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests cryptography

      - name: è®°å½•è§¦å‘æ—¶é—´
        run: |
          echo "å®šæ—¶ä»»åŠ¡è§¦å‘æˆåŠŸï¼Œå½“å‰æ—¶é—´ï¼ˆUTCï¼‰ï¼š$(date -u)"
          echo "å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$(date +'%Y-%m-%d %H:%M:%S' -d '+8 hours')"

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: checkin_step
        env:
          INVITES_COOKIE: ${{ secrets.INVITES_COOKIE }}
          INVITES_USERNAME: ${{ secrets.INVITES_USERNAME }}
          INVITES_PASSWORD: ${{ secrets.INVITES_PASSWORD }}
        run: python checkin.py

      # ä»…ä¿ç•™æ­£ç¡®çš„ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ’ä»¶ï¼ˆç§»é™¤é”™è¯¯çš„é’‰é’‰/æ— æ•ˆæ’ä»¶ï¼‰
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        uses: chf007/action-wechat-work@master
        with:
          msgtype: markdown
          webhook: ${{ secrets.WECOM_WEBHOOK }}
          content: |
            ### è¯ä¸¸è®ºå›ç­¾åˆ°é€šçŸ¥
            > **çŠ¶æ€**ï¼š${{ steps.checkin_step.outputs.checkin_result == 'success' && 'âœ… ç­¾åˆ°æˆåŠŸ' || 'âŒ ç­¾åˆ°å¤±è´¥' }}
            > **è¯¦æƒ…**ï¼š
            > ${{ steps.checkin_step.outputs.checkin_msg }}
            > **æ‰§è¡Œæ—¶é—´**ï¼š${{ github.run_at }}
            > **ğŸ¤– GitHub Actions è‡ªåŠ¨æ¨é€**
        continue-on-error: true
